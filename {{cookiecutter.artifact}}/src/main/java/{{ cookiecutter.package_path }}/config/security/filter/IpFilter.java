// This project was generated by {{ cookiecutter.author_name }} at {% now 'local', '%Y-%m-%d %X' %}.
// The version of generator is v{{ cookiecutter._version }}.

package {{ cookiecutter.basePackage }}.config.security.filter;

import {{ cookiecutter.basePackage }}.biz.sys.acl.BlacklistService;
import {{ cookiecutter.basePackage }}.biz.sys.setting.SettingService;
import {{ cookiecutter.basePackage }}.biz.sys.acl.WhitelistService;
import {{ cookiecutter.basePackage }}.common.util.CidrUtil;
import {{ cookiecutter.basePackage }}.common.util.ResponseUtil;
import org.springframework.core.env.Environment;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;
import lombok.RequiredArgsConstructor;

import javax.servlet.FilterChain;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.Arrays;
import java.util.List;


/**
 * IP黑白名单过滤器
 */
@Component
@RequiredArgsConstructor
public class IpFilter extends OncePerRequestFilter {

    final BlacklistService blacklistService;
    final WhitelistService whitelistService;
    final Environment environment;
    final SettingService setting;

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)
            throws ServletException, IOException {

        if (isDev()) {
            filterChain.doFilter(request, response);
            return;
        }

        boolean blackEnable = setting.get("blacklist.enable").isReal();
        boolean whiteEnable = setting.get("whitelist.enable").isReal();

        String ip = request.getRemoteAddr();
        List<String> blacklist = blacklistService.getBlacklist();
        List<String> whitelist = whitelistService.getWhitelist();
        if ((blackEnable && CidrUtil.in(ip, blacklist)) ||
                (whiteEnable && CidrUtil.notIn(ip, whitelist))) {

            ResponseUtil.forbidden(response);
            return;
        }
        filterChain.doFilter(request, response);
    }

    private boolean isDev() {
        String[] profiles = environment.getActiveProfiles();
        List<String> list = Arrays.asList(profiles);
        return list.contains("dev");
    }
}
