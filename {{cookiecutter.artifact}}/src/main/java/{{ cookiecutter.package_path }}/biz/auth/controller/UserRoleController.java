// This project was generated by {{ cookiecutter.author_name }} at {% now 'local', '%Y-%m-%d %X' %}.
// The version of generator is v{{ cookiecutter._version }}.

package {{ cookiecutter.basePackage }}.biz.auth.controller;

import com.baomidou.mybatisplus.core.metadata.IPage;
import {{ cookiecutter.basePackage }}.biz.auth.entity.Role;
import {{ cookiecutter.basePackage }}.biz.auth.entity.UserRole;
import {{ cookiecutter.basePackage }}.biz.auth.mapper.UserRoleMapper;
import {{ cookiecutter.basePackage }}.biz.auth.request.BatchRequest;
import {{ cookiecutter.basePackage }}.biz.auth.service.IPermissionService;
import {{ cookiecutter.basePackage }}.biz.auth.service.IUserRoleService;
import {{ cookiecutter.basePackage }}.common.controller.AuthBaseController;
import {{ cookiecutter.basePackage }}.common.request.PaginationRequest;
import {{ cookiecutter.basePackage }}.common.response.PageVO;
import {{ cookiecutter.basePackage }}.common.response.R;
import {{ cookiecutter.basePackage }}.common.util.PageRequestUtil;
import lombok.RequiredArgsConstructor;
import org.springframework.security.access.annotation.Secured;
import org.springframework.web.bind.annotation.*;

import javax.validation.Valid;
import java.util.List;

/**
 * 用户与角色关系管理
 */
@RestController
@RequestMapping("/auth")
@RequiredArgsConstructor
public class UserRoleController extends AuthBaseController {

    final IUserRoleService thisService;
    final IPermissionService permissionService;
    final UserRoleMapper thisMapper;

    /**
     * 分页查询用户拥有的角色
     *
     * @param userId 用户ID
     */
    @Secured(value = "ROLE_admin")
    @GetMapping("/users/{userId}/roles")
    public R<PageVO<Role>> list(@Valid PaginationRequest request, @PathVariable Integer userId) {
        IPage<Role> page = PageRequestUtil.checkForMp(request);
        IPage<Role> list = thisMapper.page(page, userId, request);
        return PageRequestUtil.extractFromMp(list);
    }


    /**
     * 用户新增角色
     *
     * @param userId 用户ID
     */
    @Secured(value = "ROLE_admin")
    @PostMapping("/users/{userId}/roles")
    public R<Void> add(@Valid @RequestBody UserRole entity, @PathVariable Integer userId) {
        boolean success = thisService.createRelation(userId, entity.getRoleId());
        if (success) {
            permissionService.refreshPermissions(userId);
            return R.ok("用户新增角色成功");
        }
        return R.fail("用户新增角色失败");
    }

    /**
     * 用户删除角色
     *
     * @param userId 用户ID
     * @param roleId 角色ID
     */
    @Secured(value = "ROLE_admin")
    @DeleteMapping("/users/{userId}/roles/{roleId}")
    public R<Void> delete(@PathVariable Integer userId, @PathVariable Integer roleId) {
        boolean success = thisService.deleteRelation(userId, roleId);
        if (success) {
            permissionService.refreshPermissions(userId);
            return R.ok("用户删除角色成功");
        }
        return R.fail("用户删除角色失败");
    }

    /**
     * 批量移除用户拥有的角色
     *
     * @param userId 用户ID
     */
    @Secured(value = "ROLE_admin")
    @PostMapping("/users/{userId}/roles/batch-delete")
    public R<Void> deleteBatch(@PathVariable Integer userId, @Valid @RequestBody BatchRequest request) {
        List<Integer> ids = request.getIds();
        boolean success = ids.stream()
                .allMatch(roleId -> thisService.deleteRelation(userId, roleId));

        return success ? R.ok("批量移除用户拥有的角色成功") : R.fail("批量移除用户拥有的角色失败");
    }

    /**
     * 用户批量新增角色
     *
     * @param userId 用户ID
     */
    @Secured(value = "ROLE_admin")
    @PostMapping("/users/{userId}/roles/batch-add")
    public R<Void> createBatch(@PathVariable Integer userId, @Valid @RequestBody BatchRequest request) {
        List<Integer> ids = request.getIds();
        boolean success = ids.stream()
                .allMatch(roleId -> thisService.createRelation(userId, roleId));

        return success ? R.ok("用户批量新增角色成功") : R.fail("用户批量新增角色失败");
    }

}
