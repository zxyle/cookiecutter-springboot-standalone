// This project was generated by {{ cookiecutter.author_name }} at {% now 'local', '%Y-%m-%d %X' %}.
// The version of generator is v{{ cookiecutter._version }}.

package {{ cookiecutter.basePackage }}.biz.auth.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import {{ cookiecutter.basePackage }}.biz.auth.aspect.LogOperation;
import {{ cookiecutter.basePackage }}.biz.auth.config.AuthUserProperties;
import {{ cookiecutter.basePackage }}.biz.auth.entity.User;
import {{ cookiecutter.basePackage }}.biz.auth.request.ListAuthRequest;
import {{ cookiecutter.basePackage }}.biz.auth.request.user.AdminAddUserRequest;
import {{ cookiecutter.basePackage }}.biz.auth.request.user.UpdateUserRequest;
import {{ cookiecutter.basePackage }}.biz.auth.response.UserResponse;
import {{ cookiecutter.basePackage }}.biz.auth.service.IUserService;
import {{ cookiecutter.basePackage }}.common.controller.AuthBaseController;
import {{ cookiecutter.basePackage }}.common.response.ApiResponse;
import {{ cookiecutter.basePackage }}.common.response.PageVO;
import {{ cookiecutter.basePackage }}.common.util.PageRequestUtil;
import org.apache.commons.collections4.CollectionUtils;
import org.apache.commons.lang3.StringUtils;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.web.bind.annotation.*;

import javax.validation.Valid;
import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

/**
 * 用户管理
 */
@RestController
@RequestMapping("/auth")
public class UserController extends AuthBaseController {

    AuthUserProperties properties;

    PasswordEncoder encoder;

    IUserService thisService;

    public UserController(AuthUserProperties properties, PasswordEncoder encoder, IUserService thisService) {
        this.encoder = encoder;
        this.thisService = thisService;
        this.properties = properties;
    }

    /**
     * 分页查询用户
     */
    @PreAuthorize("@ck.hasPermit('auth:user:list')")
    @GetMapping("/users")
    public ApiResponse<PageVO<UserResponse>> list(@Valid ListAuthRequest request) {
        QueryWrapper<User> wrapper = new QueryWrapper<>();
        wrapper.select("id, username, email, mobile, enabled");
        if (StringUtils.isNotBlank(request.getKeyword())) {
            wrapper.and(i -> i.like("username", request.getKeyword())
                    .or().like("email", request.getKeyword())
                    .or().like("mobile", request.getKeyword()));
        }

        // 不能将没有权限的用户信息返回
        List<Long> children = thisService.getAllChildren(getUserId());
        wrapper.in("id", children);

        wrapper.eq(request.getEnabled() != null, "enabled", request.getEnabled());
        IPage<User> page = PageRequestUtil.checkForMp(request);
        IPage<User> list = thisService.page(page, wrapper);

        // 增加角色和组信息
        List<UserResponse> userResponses = list.getRecords().stream()
                .map(user -> thisService.attachUserInfo(user, request.isFull())).collect(Collectors.toList());
        return new ApiResponse<>(new PageVO<>(userResponses, list.getTotal()));
    }


    /**
     * 使用用户名创建用户
     */
    @PreAuthorize("@ck.hasPermit('auth:user:add')")
    @PostMapping("/users")
    public ApiResponse<User> add(@Valid @RequestBody AdminAddUserRequest request) {
        if (thisService.queryByAccount(request.getAccount()) != null) {
            return new ApiResponse<>("创建失败，账号已存在", false);
        }

        // 构建用户
        User user = thisService.create(request.getAccount(), encoder.encode(request.getPassword()));
        user.setMustChangePwd((request.isMustChangePwd() && properties.isReset()) ? 1 : 0);
        boolean success = thisService.save(user);

        if (success) {
            List<Long> roleIds = new ArrayList<>();
            if (CollectionUtils.isEmpty(request.getRoleIds())) {
                roleIds.add(properties.getDefaultRole());
            } else {
                roleIds.addAll(request.getRoleIds());
            }
            // 更新用户角色、用户组关联关系, 防止被授予过高的权限的角色
            thisService.updateRelation(user.getId(), roleIds, request.getGroupIds(), null);
            return new ApiResponse<>(user);
        }

        return new ApiResponse<>("创建用户失败", false);
    }

    /**
     * 更新用户信息
     *
     * @param userId 用户ID
     */
    @PreAuthorize("@ck.hasPermit('auth:user:update')")
    @PutMapping("/users/{userId}")
    public ApiResponse<Object> update(@PathVariable Long userId, @Valid @RequestBody UpdateUserRequest request) {
        if (!groupService.isAllowed(getUserId(), userId, null)) {
            return new ApiResponse<>("没有权限更新用户", false);
        }

        // 需要防止赋予比操作者更高的权限
        thisService.updateRelation(userId, request.getRoleIds(), request.getGroupIds(), request.getPermissionIds());
        return new ApiResponse<>("更新用户成功");
    }


    /**
     * 按ID查询用户
     *
     * @param userId 用户ID
     */
    @LogOperation("按ID查询用户")
    @PreAuthorize("@ck.hasPermit('auth:user:get')")
    @GetMapping("/users/{userId}")
    public ApiResponse<UserResponse> get(@PathVariable Long userId) {
        if (!groupService.isAllowed(getUserId(), userId, null)) {
            return new ApiResponse<>("没有权限查询该用户", false);
        }

        User user = thisService.getById(userId);
        if (user != null) {
            return new ApiResponse<>(thisService.attachUserInfo(user, true));
        }
        return new ApiResponse<>("用户不存在", false);
    }

    /**
     * 按ID删除用户
     *
     * @param userId 用户ID
     */
    @LogOperation("按ID删除用户")
    @PreAuthorize("@ck.hasPermit('auth:user:delete')")
    @DeleteMapping("/users/{userId}")
    public ApiResponse<Object> delete(@PathVariable Long userId) {
        if (userId.equals(getUserId())) {
            return new ApiResponse<>("不能删除自己", false);
        }

        // 不能删除其他组的用户
        if (!groupService.isAllowed(getUserId(), userId, null)) {
            return new ApiResponse<>("没有权限删除该用户", false);
        }

        boolean success = thisService.delete(userId);
        if (success) {
            return new ApiResponse<>("已成功删除该用户");
        }
        return new ApiResponse<>("删除用户失败", false);
    }

    /**
     * 禁用用户
     *
     * @param userId 用户ID
     */
    @LogOperation("禁用用户")
    @PreAuthorize("@ck.hasPermit('auth:user:disable')")
    @PutMapping("/users/{userId}/disable")
    public ApiResponse<Object> disable(@PathVariable Long userId) {
        if (userId.equals(getUserId())) {
            return new ApiResponse<>("不能禁用自己", false);
        }

        // 不能禁用其他组的用户
        if (!groupService.isAllowed(getUserId(), userId, null)) {
            return new ApiResponse<>("没有权限禁用该用户", false);
        }

        boolean success = thisService.disable(userId);
        if (success) {
            return new ApiResponse<>("已成功禁用该用户");
        }

        return new ApiResponse<>("禁用用户失败", false);
    }

    /**
     * 启用用户
     *
     * @param userId 用户ID
     */
    @LogOperation("启用用户")
    @PreAuthorize("@ck.hasPermit('auth:user:enable')")
    @PutMapping("/users/{userId}/enable")
    public ApiResponse<Object> enable(@PathVariable Long userId) {
        if (!groupService.isAllowed(getUserId(), userId, null)) {
            return new ApiResponse<>("没有权限启用用户", false);
        }

        boolean success = thisService.enable(userId);
        if (success) {
            return new ApiResponse<>("已成功启用该用户");
        }
        return new ApiResponse<>("启用用户失败", false);
    }


    /**
     * 下线用户
     *
     * @param userId 用户ID
     */
    @LogOperation("下线用户")
    @PreAuthorize("@ck.hasPermit('auth:user:kick')")
    @PutMapping("/users/{userId}/kick")
    public ApiResponse<Object> kick(@PathVariable Long userId) {
        if (userId.equals(getUserId())) {
            return new ApiResponse<>("不能将自己下线", false);
        }

        if (!groupService.isAllowed(getUserId(), userId, null)) {
            return new ApiResponse<>("没有权限下线", false);
        }

        boolean success = thisService.kick(userId);
        if (success) {
            return new ApiResponse<>("下线成功");
        }
        return new ApiResponse<>("下线失败", false);
    }
}
