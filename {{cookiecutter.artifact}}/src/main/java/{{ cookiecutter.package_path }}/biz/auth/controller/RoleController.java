// This project was generated by {{ cookiecutter.author_name }} at {% now 'local', '%Y-%m-%d %X' %}.
// The version of generator is v{{ cookiecutter._version }}.

package {{ cookiecutter.basePackage }}.biz.auth.controller;

import cn.hutool.core.util.IdUtil;
import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import {{ cookiecutter.basePackage }}.biz.auth.aspect.LogOperation;
import {{ cookiecutter.basePackage }}.biz.auth.entity.Role;
import {{ cookiecutter.basePackage }}.biz.auth.request.ListAuthRequest;
import {{ cookiecutter.basePackage }}.biz.auth.request.role.AddRoleRequest;
import {{ cookiecutter.basePackage }}.biz.auth.request.role.UpdateRoleRequest;
import {{ cookiecutter.basePackage }}.biz.auth.response.RoleResponse;
import {{ cookiecutter.basePackage }}.biz.auth.service.IPermissionService;
import {{ cookiecutter.basePackage }}.biz.auth.service.IRoleService;
import {{ cookiecutter.basePackage }}.common.controller.AuthBaseController;
import {{ cookiecutter.basePackage }}.common.response.R;
import lombok.RequiredArgsConstructor;
import {{ cookiecutter.basePackage }}.common.response.PageVO;
import org.apache.commons.collections4.CollectionUtils;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.BeanUtils;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import javax.validation.Valid;
import java.util.List;
import java.util.stream.Collectors;

/**
 * 角色管理
 */
@RestController
@RequestMapping("/auth")
@RequiredArgsConstructor
public class RoleController extends AuthBaseController {

    final IRoleService thisService;
    final IPermissionService permissionService;

    /**
     * 角色列表分页查询
     */
    @LogOperation(name = "角色列表分页查询", biz = "auth")
    @PreAuthorize("@ck.hasPermit('auth:role:list')")
    @GetMapping("/roles")
    public R<PageVO<RoleResponse>> list(@Valid ListAuthRequest req) {
        QueryWrapper<Role> wrapper = new QueryWrapper<>();
        wrapper.select("id, name, code, description");
        // 模糊查询
        if (StringUtils.isNotBlank(req.getKeyword())) {
            wrapper.and(i -> i.like("name", req.getKeyword())
                    .or().like("code", req.getKeyword())
                    .or().like("description", req.getKeyword()));
        }
        IPage<Role> list = thisService.page(req.toPageable(), wrapper);
        List<RoleResponse> roles = list.getRecords().stream()
                .map(role -> thisService.attachRoleInfo(role, req.isFull()))
                .collect(Collectors.toList());
        return R.ok(new PageVO<>(roles, list.getTotal()));
    }


    /**
     * 创建角色
     */
    @LogOperation(name = "创建角色", biz = "auth")
    @PreAuthorize("@ck.hasPermit('auth:role:add')")
    @PostMapping("/roles")
    public R<Role> add(@Valid @RequestBody AddRoleRequest request) {
        if (thisService.isDuplicate(request.getName(), request.getCode())) {
            return R.fail("角色名称或角色代码已重复");
        }

        Role role = new Role();
        BeanUtils.copyProperties(request, role);
        if (StringUtils.isBlank(role.getCode())) {
            role.setCode(IdUtil.simpleUUID());
        }
        boolean success = thisService.save(role);
        if (success && CollectionUtils.isNotEmpty(request.getPermissionIds())) {
            // 保存角色权限关系
            thisService.updateRelation(role.getId(), request.getPermissionIds());
        }
        return R.ok(role);
    }


    /**
     * 按ID查询角色
     *
     * @param roleId 角色ID
     */
    @LogOperation(name = "按ID查询角色", biz = "auth")
    @PreAuthorize("@ck.hasPermit('auth:role:get')")
    @GetMapping("/roles/{roleId}")
    public R<RoleResponse> get(@PathVariable Integer roleId) {
        Role role = thisService.findById(roleId);
        if (role == null) return R.fail("角色不存在");

        // 查询角色对应权限关系
        RoleResponse response = thisService.attachRoleInfo(role, true);
        return R.ok(response);
    }

    /**
     * 按ID更新角色
     *
     * @param roleId 角色ID
     */
    @LogOperation(name = "按ID更新角色", biz = "auth")
    @PreAuthorize("@ck.hasPermit('auth:role:update')")
    @PutMapping("/roles/{roleId}")
    public R<Void> update(@Valid @RequestBody UpdateRoleRequest request, @PathVariable Integer roleId) {
        // 更新角色信息
        Role role = new Role();
        BeanUtils.copyProperties(request, role);
        role.setId(roleId);
        boolean success = thisService.updateById(role);

        // 更新角色权限关联关系
        if (success && CollectionUtils.isNotEmpty(request.getPermissionIds())) {
            thisService.updateRelation(roleId, request.getPermissionIds());

            // 刷新持有该角色的用户权限缓存
            List<Integer> users = getUsersByRole(roleId);
            users.forEach(permissionService::refreshPermissions);
        }
        return R.ok("更新角色成功");
    }

    /**
     * 按ID删除角色
     *
     * @param roleId 角色ID
     */
    @LogOperation(name = "按ID删除角色", biz = "auth")
    @PreAuthorize("@ck.hasPermit('auth:role:delete')")
    @DeleteMapping("/roles/{roleId}")
    public R<Void> delete(@PathVariable Integer roleId) {
        if (thisService.isAlreadyUsed(roleId)) {
            return R.fail("该角色正在使用，无法删除");
        }

        boolean success = thisService.delete(roleId);
        if (success) {
            // 刷新持有该角色的用户权限缓存
            List<Integer> users = getUsersByRole(roleId);
            users.forEach(permissionService::refreshPermissions);
            return R.ok("删除角色成功");
        }

        return R.fail("删除角色失败");
    }
}
