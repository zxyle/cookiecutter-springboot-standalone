// This project was generated by {{ cookiecutter.author_name }} at {% now 'local', '%Y-%m-%d %X' %}.
// The version of generator is v{{ cookiecutter._version }}.

package {{ cookiecutter.basePackage }}.biz.auth.service;

import {{ cookiecutter.basePackage }}.biz.auth.security.CaptchaProperties;
import {{ cookiecutter.basePackage }}.biz.sys.service.CaptchaPair;
import {{ cookiecutter.basePackage }}.biz.sys.service.CaptchaService;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.stereotype.Service;

import javax.annotation.Resource;
import java.util.concurrent.TimeUnit;

@Service
public class CodeService {

    @Resource
    StringRedisTemplate stringRedisTemplate;

    @Autowired
    CaptchaProperties captchaProperties;

    @Autowired
    CaptchaService captchaService;


    /**
     * 生成验证码
     */
    public CaptchaPair send() {
        CaptchaPair captchaPair = captchaService.generate();
        String redisKey = captchaProperties.getKeyPrefix() + captchaPair.getCaptchaId();
        String code = captchaPair.getCode();
        stringRedisTemplate.opsForValue().set(redisKey, code, captchaProperties.getAliveTime(), TimeUnit.MINUTES);
        return captchaPair;
    }

    /**
     * 校验验证码
     *
     * @param captchaId 验证码ID
     * @param code      验证码
     * @return 校验结果 true-通过、 false-不通过
     */
    public boolean verify(String code, String captchaId) {
        if (StringUtils.isBlank(code) || StringUtils.isBlank(captchaId)) {
            return false;
        }

        String redisKey = captchaProperties.getKeyPrefix() + captchaId;
        Boolean hasKey = stringRedisTemplate.hasKey(redisKey);
        if (Boolean.FALSE.equals(hasKey)) {
            return false;
        }

        String captchaRedis = stringRedisTemplate.opsForValue().get(redisKey);
        if (StringUtils.isBlank(captchaRedis))
            return false;

        boolean match = captchaRedis.trim().equalsIgnoreCase(code);
        if (match) {
            stringRedisTemplate.delete(captchaId);
        }
        return match;
    }
}
