// This project was generated by {{ cookiecutter.author_name }} at {% now 'local', '%Y-%m-%d %X' %}.
// The version of generator is v{{ cookiecutter._version }}.

package {{ cookiecutter.basePackage }}.biz.auth.service.impl;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.conditions.update.UpdateWrapper;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import {{ cookiecutter.basePackage }}.biz.auth.constant.AuthConst;
import {{ cookiecutter.basePackage }}.biz.auth.entity.*;
import {{ cookiecutter.basePackage }}.biz.sys.util.CaptchaUtil;
import {{ cookiecutter.basePackage }}.biz.auth.mapper.UserMapper;
import {{ cookiecutter.basePackage }}.biz.auth.response.UserResponse;
import {{ cookiecutter.basePackage }}.biz.auth.service.*;
import {{ cookiecutter.basePackage }}.biz.auth.util.AccountUtil;
import lombok.RequiredArgsConstructor;
import org.apache.commons.collections4.CollectionUtils;
import org.springframework.beans.BeanUtils;
import org.springframework.cache.annotation.CacheConfig;
import org.springframework.cache.annotation.CacheEvict;
import org.springframework.cache.annotation.Cacheable;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

/**
 * 用户 服务实现类
 */
@Service
@RequiredArgsConstructor
@CacheConfig(cacheNames = "UserCache")
public class UserServiceImpl extends ServiceImpl<UserMapper, User> implements IUserService {

    final StringRedisTemplate stringRedisTemplate;
    final IUserGroupService userGroupService;
    final IUserRoleService userRoleService;
    final IUserPermissionService userPermissionService;
    final IGroupService groupService;
    final IProfileService profileService;

    // 删除用户及其关联角色、用户组、权限
    @CacheEvict(key = "#userId")
    @Transactional
    @Override
    public boolean delete(Integer userId) {
        boolean s1 = userPermissionService.deleteRelation(userId, 0);
        boolean s2 = userRoleService.deleteRelation(userId, 0);
        boolean s3 = userGroupService.deleteRelation(userId, 0);
        boolean s4 = removeById(userId);
        boolean s5 = profileService.delete(userId);
        boolean s6 = kick(userId);
        return (s1 && s2) && (s3 && s4) && (s5 && s6);
    }


    // 禁用用户
    @Override
    public boolean disable(Integer userId) {
        User user = new User();
        user.setId(userId);
        user.setEnabled(false);
        boolean success = updateById(user);
        return success && kick(userId);
    }

    // 启用用户
    @Override
    public boolean enable(Integer userId) {
        User user = new User();
        user.setId(userId);
        user.setEnabled(true);
        return updateById(user);
    }

    // 下线用户
    @Override
    public boolean kick(Integer userId) {
        String key = AuthConst.KEY_PREFIX + userId;
        Boolean hasKey = stringRedisTemplate.hasKey(key);
        if (hasKey == null || !hasKey) {
            // 用户可能没有登录或登录已过期
            return true;
        }
        Boolean delete = stringRedisTemplate.delete(key);
        return Boolean.TRUE.equals(delete);
    }

    // 通过账号名查询用户
    @Cacheable(cacheNames = "UserCache", key = "#account", unless = "#result == null")
    @Override
    public User findByAccount(String account) {
        QueryWrapper<User> wrapper = new QueryWrapper<>();
        wrapper.eq(AccountUtil.isUsername(account), "username", account);
        wrapper.eq(AccountUtil.isEmail(account), "email", account);
        wrapper.eq(AccountUtil.isMobile(account), "mobile", account);
        return getOne(wrapper);
    }

    // 查询用户拥有的角色、用户组、权限
    @Override
    public UserResponse attachUserInfo(User user, boolean full) {
        UserResponse userResponse = new UserResponse();
        if (full) {
            List<Group> groups = userGroupService.findGroupsByUserId(user.getId());
            userResponse.setGroups(CollectionUtils.isNotEmpty(groups) ? groups : null);

            List<Role> roles = userRoleService.findRolesByUserId(user.getId());
            userResponse.setRoles(CollectionUtils.isNotEmpty(roles) ? roles : null);

            List<Permission> permissions = userPermissionService.findPermissionsByUserId(user.getId());
            userResponse.setPermissions(CollectionUtils.isNotEmpty(permissions) ? permissions : null);
        }

        BeanUtils.copyProperties(user, userResponse);
        return userResponse;
    }

    // 更新用户关联的角色、用户组、权限
    @Override
    public void updateRelation(Integer userId, List<Integer> roleIds, List<Integer> groupIds, List<Integer> permissionIds) {
        userRoleService.updateRelation(userId, roleIds);
        userGroupService.updateRelation(userId, groupIds);
        userPermissionService.updateRelation(userId, permissionIds);
    }

    // 创建用户
    @Override
    public User create(String account, String encodedPassword) {
        User user = new User();
        user.setPwd(encodedPassword);
        user.setNickname("用户_" + CaptchaUtil.randAlphabet(6));
        if (AccountUtil.isMobile(account)) {
            user.setMobile(account);
        } else if (AccountUtil.isEmail(account)) {
            user.setEmail(account);
        } else {
            user.setUsername(account);
        }
        return user;
    }

    // 获取所有有管理权限用户组成员
    @Override
    public List<Integer> getAllChildren(Integer userId) {
        // 查询用户有管理员权限的用户组
        QueryWrapper<UserGroup> queryWrapper = new QueryWrapper<>();
        queryWrapper.select("user_id, group_id");
        queryWrapper.eq("user_id", userId);
        queryWrapper.eq("admin", AuthConst.ENABLED);
        List<UserGroup> userGroups = userGroupService.list(queryWrapper);

        // 查询用户组的所有子用户组
        List<Group> allGroups = new ArrayList<>();
        List<Group> groups = groupService.list();
        for (UserGroup userGroup : userGroups) {
            allGroups.addAll(groupService.getAllChildren(groups, userGroup.getGroupId()));
        }

        // 查询用户组下的所有用户
        QueryWrapper<UserGroup> userGroupQueryWrapper = new QueryWrapper<>();
        userGroupQueryWrapper.select("user_id, group_id");
        List<Integer> groupIds = allGroups.stream().distinct().map(Group::getId).collect(Collectors.toList());
        userGroupQueryWrapper.in("group_id", groupIds);
        List<UserGroup> userGroupList = userGroupService.list(userGroupQueryWrapper);
        return userGroupList.stream().map(UserGroup::getUserId).collect(Collectors.toList());
    }

    // 锁定用户并退出当前登录状态
    @Override
    public boolean locked(Integer userId) {
        UpdateWrapper<User> wrapper = new UpdateWrapper<>();
        wrapper.eq("id", userId);
        wrapper.set("locked", AuthConst.LOCKED);
        boolean update = update(wrapper);
        boolean kick = kick(userId);
        return update && kick;
    }

    // 解锁用户
    @Override
    public boolean unlock(Integer userId) {
        UpdateWrapper<User> wrapper = new UpdateWrapper<>();
        wrapper.eq("id", userId);
        wrapper.set("locked", AuthConst.UNLOCKED);
        boolean update = update(wrapper);

        String key = "pwd:change:" + userId;
        if (Boolean.TRUE.equals(stringRedisTemplate.hasKey(key)))
            stringRedisTemplate.delete(key);
        return update;
    }

    // 带缓存的ID查询
    @Cacheable(key = "#userId", unless = "#result == null")
    @Override
    public User findById(Integer userId) {
        return getById(userId);
    }
}
