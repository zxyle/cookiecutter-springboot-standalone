// This project was generated by {{ cookiecutter.author_name }} at {% now 'local', '%Y-%m-%d %X' %}.
// The version of generator is v{{ cookiecutter._version }}.

package {{ cookiecutter.basePackage }}.biz.auth.security.filter;

import {{ cookiecutter.basePackage }}.common.util.ResponseUtil;
import org.apache.commons.lang3.StringUtils;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import javax.servlet.FilterChain;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.Arrays;
import java.util.List;

/**
 * SQL注入关键词过滤器
 */
@Component
public class SqlInjectionFilter extends OncePerRequestFilter {

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)
            throws ServletException, IOException {

        String[] sqlInj = {"select", "insert", "update", "delete", "drop", "truncate", "alter", "create", "exec",
                "execute", "declare", "call", "count", "master", "char", "sitename", "and", "chr", "mid",
                "net user", "xp_cmdshell", "exec master", "netlocalgroup administrators"};
        List<String> sqlInjList = Arrays.asList(sqlInj);
        String url = request.getRequestURI();
        String method = request.getMethod();
        String queryString = request.getQueryString();
        // 无法读取到请求体中的数据, 读取完之后，就无法再读取了，导致controller 报错 request body missing

        if (sqlInjList.stream().anyMatch(url::contains) ||
                (StringUtils.isNotBlank(queryString) && sqlInjList.stream().anyMatch(queryString::contains))
                || sqlInjList.stream().anyMatch(method::contains)) {
            ResponseUtil.forbidden(response);
            return;
        }
        filterChain.doFilter(request, response);
    }


}
