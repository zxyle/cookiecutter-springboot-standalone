// This project was generated by {{ cookiecutter.author_name }} at {% now 'local', '%Y-%m-%d %X' %}.
// The version of generator is v{{ cookiecutter._version }}.

package {{ cookiecutter.basePackage }}.biz.sdk.controller;

import {{ cookiecutter.basePackage }}.biz.auth.constant.AuthConst;
import {{ cookiecutter.basePackage }}.biz.sdk.entity.OpenApi;
import {{ cookiecutter.basePackage }}.biz.sdk.request.SdkRequest;
import {{ cookiecutter.basePackage }}.config.security.WildcardPermission;
import {{ cookiecutter.basePackage }}.biz.sdk.service.IOpenApiService;
import {{ cookiecutter.basePackage }}.biz.auth.util.JwtUtil;
import {{ cookiecutter.basePackage }}.biz.auth.util.ObjectToHashMap;
import {{ cookiecutter.basePackage }}.biz.auth.util.SignUtils;
import io.jsonwebtoken.Claims;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.StringUtils;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.web.bind.annotation.*;

import javax.servlet.http.HttpServletRequest;
import javax.validation.Valid;
import java.util.Arrays;
import java.util.Collections;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

/**
 * SDK接口
 */
@Slf4j
@RestController
@RequiredArgsConstructor
@RequestMapping("/auth/sdk")
public class SdkController {

    private final WildcardPermission wildcardPermission = new WildcardPermission();

    final StringRedisTemplate stringRedisTemplate;
    final HttpServletRequest servletRequest;
    final IOpenApiService openApiService;

    /**
     * 获取用户ID
     */
    @PostMapping("/getUserId")
    public Long parseToken(@Valid @RequestBody SdkRequest request) {
        if (!before(request)) {
            return null;
        }

        String userId = parseUserId(request.getToken());
        return StringUtils.isBlank(userId) ? null : Long.parseLong(userId);
    }

    /**
     * 判断用户是否登录
     */
    @PostMapping("/isLogin")
    public boolean isLogin(@Valid @RequestBody SdkRequest request) {
        if (!before(request)) {
            return false;
        }

        String userId = parseUserId(request.getToken());
        if (StringUtils.isBlank(userId))
            return false;

        String key = AuthConst.KEY_PREFIX + userId;
        return Boolean.TRUE.equals(stringRedisTemplate.hasKey(key));
    }

    /**
     * 判断用户是否有权限
     *
     * @return true-有权限，false-无权限
     */
    @PostMapping("/allowed")
    public boolean allowed(@Valid @RequestBody SdkRequest request) {
        // TODO 记录日志
        if (!before(request)) return false;

        String permission = request.getPermission();
        String userId = parseUserId(request.getToken());
        String key = AuthConst.KEY_PREFIX + userId;
        String value = stringRedisTemplate.opsForValue().get(key);
        if (StringUtils.isBlank(value))
            return false;

        List<String> patterns = Arrays.asList(value.split(AuthConst.DELIMITER));
        boolean result = wildcardPermission.isPermit(permission, patterns);
        log.info("permission: " + permission + ", result: " + result);
        return result;
    }

    /**
     * 获取权限列表
     */
    @PostMapping("/permissions")
    public List<String> permissions(@Valid @RequestBody SdkRequest request) {
        if (!before(request)) return Collections.emptyList();

        String userId = parseUserId(request.getToken());
        List<String> permissions = getPermissions(userId);
        return permissions.stream().filter(e -> !e.startsWith("ROLE_"))
                .collect(Collectors.toList());
    }

    /**
     * 获取角色列表
     */
    @PostMapping("/roles")
    public List<String> roles(@Valid @RequestBody SdkRequest request) {
        String userId = parseUserId(request.getToken());
        List<String> permissions = getPermissions(userId);
        return permissions.stream().filter(e -> e.startsWith("ROLE_"))
                .map(e -> e.substring(5))
                .collect(Collectors.toList());
    }

    public List<String> getPermissions(String userId) {
        String key = AuthConst.KEY_PREFIX + userId;
        String value = stringRedisTemplate.opsForValue().get(key);
        if (StringUtils.isBlank(value))
            return Collections.emptyList();

        return Arrays.asList(value.split(AuthConst.DELIMITER));
    }

    public String parseUserId(String token) {
        try {
            Claims claims = JwtUtil.parseJWT(token);
            return claims.getSubject();
        } catch (Exception ignored) {
            log.error("解析token失败，token: {}", token);
            return null;
        }
    }

    public boolean before(SdkRequest request) {
        OpenApi openApi = openApiService.getValidOpenApi(request.getAppId());
        if (openApi == null) {
            log.info("appId: {} 不存在或已过期", request.getAppId());
            return false;
        }

        Map<String, String> map = ObjectToHashMap.convertObjectToHashMap(request);
        map.put("appSecret", openApi.getAppSecret());
        if (!SignUtils.isCorrect(map)) {
            log.info("appId: {} 签名错误", request.getAppId());
            return false;
        }

        String token = request.getToken();
        String userId = parseUserId(token);
        if (StringUtils.isBlank(userId)) {
            log.info("token: {} 无效", token);
            return false;
        }

        return true;
    }

}
