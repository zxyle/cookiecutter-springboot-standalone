// This project was generated by {{ cookiecutter.author_name }} at {% now 'local', '%Y-%m-%d %X' %}.
// And git commit hash is {% gitcommit %}.

package {{ cookiecutter.basePackage }}.biz.sys.service.impl;

import cn.hutool.http.HttpRequest;
import {{ cookiecutter.basePackage }}.biz.sys.service.DingTalkResponse;
import {{ cookiecutter.basePackage }}.biz.sys.setting.SettingService;
import {{ cookiecutter.basePackage }}.biz.sys.service.MonitoringAlarmService;
import {{ cookiecutter.basePackage }}.common.util.JacksonUtil;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;


/**
 * 钉钉告警发送
 * <a href="https://open.dingtalk.com/document/robots/custom-robot-access">接口文档</a>
 */
@Service
@RequiredArgsConstructor
public class DingTalkAlarmServiceImpl implements MonitoringAlarmService {

    final SettingService setting;

    @Override
    public boolean sendAlarm(String msg) {
        String accessToken = setting.get("dingtalk.access-token").getStr();
        String content = "{\"msgtype\": \"text\",\"text\": {\"content\":" + "\"" + msg + "\"}}";
        String result = HttpRequest.post("https://oapi.dingtalk.com/robot/send?access_token=" + accessToken)
                .body(content)
                .timeout(2000)
                .execute()
                .body();
        DingTalkResponse response = JacksonUtil.deserialize(result, DingTalkResponse.class);
        return response != null && response.getErrcode() == 0 && response.getErrmsg().equals("ok");

    }
}
