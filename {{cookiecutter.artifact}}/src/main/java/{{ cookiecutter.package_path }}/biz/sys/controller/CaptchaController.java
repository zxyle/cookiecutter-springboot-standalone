// This project was generated by {{ cookiecutter.author_name }} at {% now 'local', '%Y-%m-%d %X' %}.
// The version of generator is v{{ cookiecutter._version }}.

package {{ cookiecutter.basePackage }}.biz.sys.controller;

import {{ cookiecutter.basePackage }}.biz.auth.config.AuthUserProperties;
import {{ cookiecutter.basePackage }}.biz.auth.entity.User;
import {{ cookiecutter.basePackage }}.biz.auth.request.SendCodeRequest;
import {{ cookiecutter.basePackage }}.biz.auth.security.CaptchaProperties;
import {{ cookiecutter.basePackage }}.biz.auth.service.CodeService;
import {{ cookiecutter.basePackage }}.biz.auth.service.EmailCodeService;
import {{ cookiecutter.basePackage }}.biz.auth.service.IUserService;
import {{ cookiecutter.basePackage }}.biz.sys.response.CaptchaResponse;
import {{ cookiecutter.basePackage }}.biz.sys.service.CaptchaPair;
import {{ cookiecutter.basePackage }}.biz.sys.util.CaptchaUtil;
import {{ cookiecutter.basePackage }}.common.response.ApiResponse;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.http.HttpStatus;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import javax.servlet.http.Cookie;
import javax.servlet.http.HttpServletResponse;
import javax.validation.constraints.NotBlank;
import java.io.IOException;
import java.time.Duration;
import java.util.concurrent.TimeUnit;

/**
 * 图形数字验证码
 */
@RestController
@RequestMapping("/sys/captcha")
@Validated
@Slf4j
public class CaptchaController {

    StringRedisTemplate stringRedisTemplate;

    IUserService userService;

    CaptchaProperties captchaProperties;

    AuthUserProperties authUserProperties;

    EmailCodeService emailService;

    CodeService codeService;

    public CaptchaController(StringRedisTemplate stringRedisTemplate, IUserService userService, CaptchaProperties captchaProperties, AuthUserProperties authUserProperties, EmailCodeService emailService, CodeService codeService) {
        this.stringRedisTemplate = stringRedisTemplate;
        this.userService = userService;
        this.captchaProperties = captchaProperties;
        this.authUserProperties = authUserProperties;
        this.emailService = emailService;
        this.codeService = codeService;
    }

    /**
     * 生成base64编码图形验证码
     */
    @GetMapping("/generate")
    public ApiResponse<CaptchaResponse> generate() {
        CaptchaPair captchaPair = codeService.send();
        CaptchaResponse response = new CaptchaResponse(captchaPair.getCaptchaId(), captchaPair.getB64Image());
        return new ApiResponse<>(response);
    }


    /**
     * 生成图形验证码
     */
    @GetMapping("/captchaImage")
    public void get(HttpServletResponse response) throws IOException {
        response.setHeader("Pragma", "no-cache");
        response.setHeader("Cache-Control", "no-cache");
        response.setDateHeader("Expires", 0);  // 在代理服务器端防止缓冲
        response.setContentType("image/jpeg");
        CaptchaPair captchaPair = codeService.send();
        Cookie cookie = new Cookie("captchaId", captchaPair.getCaptchaId());
        cookie.setPath("/");
        response.addCookie(cookie);
        response.getOutputStream().write(captchaPair.getBytes());
        response.getOutputStream().flush();
    }


    /**
     * 校验短信、图形验证码
     *
     * @param code      用户输入结果
     * @param captchaId 图形验证码id
     */
    @GetMapping("/verify")
    public ApiResponse<Boolean> verify(@NotBlank String code, @NotBlank String captchaId) {
        boolean verify = codeService.verify(code, captchaId);
        return new ApiResponse<>(verify);
    }

    /**
     * 发送短信邮件验证码
     */
    @GetMapping("/send")
    public ApiResponse<Boolean> send(SendCodeRequest request) {
        if (isLocked(request.getPrincipal())) {
            return new ApiResponse<>(HttpStatus.BAD_REQUEST.toString(), "请求验证码频繁", false);
        }
        User user = userService.queryByPrincipal(null, request.getEmail());

        String key = "code:" + request.getPrincipal();
        // 生成随机数字
        String code = CaptchaUtil.randNumber(captchaProperties.getDigits());
        stringRedisTemplate.opsForHash().put(key, "principal", request.getPrincipal());
        stringRedisTemplate.opsForHash().put(key, "code", code);
        if (user != null && user.getId() != null) {
            // 针对已经注册的用户, 保存用户id
            stringRedisTemplate.opsForHash().put(key, "userId", String.valueOf(user.getId()));
        }

        stringRedisTemplate.expire(key, Duration.ofMinutes(captchaProperties.getAliveTime()));

        if (authUserProperties.getPrincipal().equals("email")) {
            // 调用邮件发送方法
            boolean success = emailService.sendVerificationCode(code, request.getEmail());
            log.info("给 {} 发送邮件验证码结果: {}", request.getEmail(), success);
        }

        if (authUserProperties.getPrincipal().equals("mobile")) {
            // TODO 调用发送短信接口, 写入到消息队列中
        }
        locked(request.getPrincipal(), captchaProperties.getBetween());
        return new ApiResponse<>(true);
    }

    // 防止验证码被滥用
    public void locked(String principal, Integer between) {
        String key = "locked:" + principal;
        stringRedisTemplate.opsForValue().set(key, "lock", captchaProperties.getBetween(), TimeUnit.SECONDS);
    }

    public boolean isLocked(String principal) {
        String key = "locked:" + principal;
        return Boolean.TRUE.equals(stringRedisTemplate.hasKey(key));
    }

}
